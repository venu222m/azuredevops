Here is a detailed step-by-step guide for setting up a pipeline with your own self-hosted agent in Azure DevOps. This includes:

Creating a pipeline

Setting up your own self-hosted agent (Linux/Ubuntu example)

Running the pipeline using the agent

üîß Prerequisites
Azure DevOps account and project

Git repo with sample code (can be public/private)

Linux VM (Ubuntu) or Windows machine with internet access

Azure DevOps PAT (Personal Access Token)

‚úÖ Step 1: Create an Agent Pool
Go to Azure DevOps Portal ‚Üí your Project

Click on Project settings (bottom left)

Under Pipelines, click Agent pools

Click Add pool

Name: my-selfhosted-pool

Choose: Self-hosted

Click Create

‚úÖ Step 2: Generate PAT (Personal Access Token)
Click on your profile icon ‚Üí Security

Under Personal Access Tokens, click New Token

Name: agent-token

Organization: your Azure DevOps org

Expiration: 90 days or more

Scopes: Agent Pools (Read & Manage)

Click Create ‚Üí Copy the token immediately

‚úÖ Step 3: Download and Configure the Agent (Linux Example)
On your Ubuntu VM, run the following:

bash
Copy
Edit
# 1. Create directory
mkdir myagent && cd myagent

# 2. Download the agent (get the latest URL from Azure DevOps)
wget https://vstsagentpackage.azureedge.net/agent/3.236.1/vsts-agent-linux-x64-3.236.1.tar.gz

# 3. Extract
tar zxvf vsts-agent-linux-x64-3.236.1.tar.gz

# 4. Install dependencies
sudo apt-get update
sudo apt-get install -y libcurl4 openssh-client libicu[0-9][0-9] jq

# 5. Configure the agent
./config.sh
URL: https://dev.azure.com/your_org_name

PAT: Paste your token

Agent Pool: my-selfhosted-pool

Agent Name: my-linux-agent

Accept all defaults or customize if needed

‚úÖ Step 4: Start the Agent
bash
Copy
Edit
# Start agent manually (foreground)
./run.sh

# OR configure it as a service
sudo ./svc.sh install
sudo ./svc.sh start
‚úÖ Step 5: Create a Pipeline Using the Agent Pool
In Azure DevOps:

Go to Pipelines ‚Üí Click New Pipeline

Select your repo (e.g., GitHub or Azure Repos)

Choose YAML

Add below example YAML:

yaml
Copy
Edit
trigger:
- main

pool:
  name: my-selfhosted-pool

steps:
- script: echo "Running on self-hosted agent!"
  displayName: 'Test Self-Hosted Agent'

- script: uname -a
  displayName: 'Show OS Info'
Save and Run

‚úÖ Step 6: Validate
Your pipeline should pick the self-hosted agent

Check logs: it will show the agent name you configured

You can also view the agent status under Project Settings > Agent Pools > my-selfhosted-pool

üßº Optional: Install Agent as Service on Reboot (Linux)
bash
Copy
Edit
sudo ./svc.sh install
sudo ./svc.sh start
sudo systemctl enable vsts.agent.*
‚úÖ Bonus: Agent Logs & Status
Logs: ~/myagent/_diag/

Status: Check with ./svc.sh status

Restart: ./svc.sh restart

üîê Security Tips
Never expose your PAT or allow passwordless SSH access to agent VMs

Use firewalls, NSGs, and strong authentication

Revoke PATs if agent is compromised

Let me know if you want:

Windows agent setup steps

How to run Docker, Terraform, Ansible on your agent

Auto-scaling self-hosted agents (VMSS or Kubernetes)
==========================================================
To run Docker, Terraform, and Ansible on your self-hosted Azure DevOps agent, you must install and configure each tool on the machine where the agent is running.
----------------------------------------------------------new concept

Here's a complete guide for a Linux (Ubuntu-based) self-hosted agent VM.

üß± Prerequisite: Self-hosted Agent Already Running
Make sure:

Your Azure DevOps agent is installed and running (./run.sh or svc.sh start)

You're using Ubuntu or compatible Linux distro

You have sudo access

üê≥ 1. Install Docker on Agent VM
‚û§ Install Docker:
bash
Copy
Edit
sudo apt-get update
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# Add Docker‚Äôs GPG key:
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# Set up the repo:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install Docker:
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

# Allow agent user to use Docker:
sudo usermod -aG docker $(whoami)

# (Optional) Verify:
docker --version
Important: You must restart your shell or log out/in for Docker group access to work.

üåç 2. Install Terraform
‚û§ Install Terraform:
bash
Copy
Edit
# Download HashiCorp GPG
wget -O- https://apt.releases.hashicorp.com/gpg | \
  gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg

# Add official repo:
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
sudo tee /etc/apt/sources.list.d/hashicorp.list

# Install Terraform
sudo apt update && sudo apt install -y terraform

# Verify
terraform -version
üß∞ 3. Install Ansible
‚û§ Install Ansible:
bash
Copy
Edit
sudo apt update
sudo apt install -y software-properties-common
sudo add-apt-repository --yes --update ppa:ansible/ansible
sudo apt install -y ansible

# Verify
ansible --version
üîÅ 4. Restart Agent After Installation
bash
Copy
Edit
# If using service
sudo ./svc.sh restart

# If running manually
CTRL+C then ./run.sh again
üß™ 5. Sample Azure DevOps YAML Using Docker, Terraform, and Ansible
‚û§ Sample azure-pipelines.yml:
yaml
Copy
Edit
trigger:
- main

pool:
  name: my-selfhosted-pool

steps:

- script: |
    echo "Running Terraform"
    terraform version
  displayName: 'Terraform Check'

- script: |
    echo "Running Ansible"
    ansible --version
  displayName: 'Ansible Check'

- script: |
    echo "Running Docker"
    docker --version
    docker run hello-world
  displayName: 'Docker Test'
‚úÖ Troubleshooting Tips
Issue	Fix
docker: permission denied	Run sudo usermod -aG docker $(whoami) and reboot or re-login
Terraform not found	Ensure terraform is installed and in PATH
Ansible command not found	Run ansible --version manually on VM and check install
Pipeline hangs or fails on run	Check agent logs in ~/myagent/_diag or run in foreground

üöÄ Bonus: Use Docker to Run Ansible or Terraform
You can also use Docker containers to run Terraform/Ansible in isolation:

yaml
Copy
Edit
- script: |
    docker run --rm -v $(pwd):/workspace -w /workspace hashicorp/terraform:light version
  displayName: 'Run Terraform in Docker'

- script: |
    docker run --rm -v $(pwd):/workspace -w /workspace williamyeh/ansible:alpine3 ansible --version
  displayName: 'Run Ansible in Docker'
